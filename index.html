
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>åˆ†è²è­¦å ±å™¨</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      background-color: #f0f8ff;
      padding: 30px;
      font-size: 22px;
      text-align: center;
    }
    h1 { color: #0066cc; font-size: 36px; }
    label, input {
      display: block;
      margin: 10px auto;
      font-size: 22px;
    }
    input[type="number"], input[type="text"] {
      padding: 5px 10px;
      width: 80%;
      max-width: 300px;
      font-size: 22px;
      text-align: center;
    }
    button {
      font-size: 22px;
      margin: 10px;
      padding: 10px 20px;
    }
    #dbDisplay, #exceedDisplay, #status {
      margin-top: 15px;
      font-weight: bold;
    }
    #visualAlert {
      margin: 30px auto;
      padding: 20px;
      width: 80%;
      font-size: 28px;
      font-weight: bold;
      border-radius: 12px;
    }
    .quiet {
      background-color: #d4edda;
      color: #155724;
    }
    .loud {
      background-color: #f8d7da;
      color: #721c24;
    }
    #historyList {
      margin-top: 30px;
      border-top: 2px dashed #ccc;
      padding-top: 10px;
      list-style: none;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }
    #historyList li {
      margin-bottom: 8px;
    }
    footer {
      margin-top: 40px;
      font-size: 18px;
      color: #444;
    }
    footer img {
      height: 50px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1><img src="favicon_large.png" width="64"> åˆ†è²è­¦å ±å™¨ <img src="favicon_large.png" width="64"></h1>

  <label>è­¦å‘Šåˆ†è²ï¼š
    <input type="number" id="threshold" value="75">
  </label>

  <label>å¯è¶…éæ¬¡æ•¸ï¼š
    <input type="number" id="maxExceed" value="3">
  </label>

  <label>è¶…æ¨™æ™‚èªéŸ³æé†’ï¼š
    <input type="text" id="warningText" value="å¤ªåµäº†ï¼Œè«‹é™ä½éŸ³é‡">
  </label>

  <label>é€£çºŒçµæŸèªéŸ³æé†’ï¼š
    <input type="text" id="endText" value="è«‹åœä¸‹æ‰‹é‚Šå‹•ä½œï¼Œå›åˆ°åº§ä½">
  </label>

  <button onclick="startMonitoring()">é–‹å§‹ç›£æ¸¬</button>
  <button onclick="stopMonitoring()">åœæ­¢ç›£æ¸¬</button>

  <p id="dbDisplay">ç›®å‰éŸ³é‡ï¼š0 dB</p>
  <p id="exceedDisplay">å·²è¶…éæ¬¡æ•¸ï¼š0</p>
  <p id="status">ç‹€æ…‹ï¼šå°šæœªé–‹å§‹</p>

  <div id="visualAlert" class="quiet">ç›®å‰å®‰éœ</div>

  <ul id="historyList"></ul>

  <footer>
    ğŸ‘©â€ğŸ« è£½ä½œäººï¼šFrieda è€å¸«
    <div><img src="logo.png" alt="Frieda logo"></div>
  </footer>

  <script>
    let audioContext, mic, analyser, dataArray;
    let threshold = 60;
    let maxExceed = 3;
    let exceedCount = 0;
    let monitoring = false;
    let isSpeaking = false;
    let rafId;

    function speak(text, callback) {
      isSpeaking = true;
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'zh-TW';
      utterance.onend = () => {
        isSpeaking = false;
        if (callback) callback();
      };
      speechSynthesis.speak(utterance);
    }

    function startMonitoring() {
      threshold = parseInt(document.getElementById('threshold').value);
      maxExceed = parseInt(document.getElementById('maxExceed').value);
      exceedCount = 0;
      document.getElementById('exceedDisplay').textContent = `å·²è¶…éæ¬¡æ•¸ï¼š0`;
      document.getElementById('status').textContent = 'ç‹€æ…‹ï¼šç›£æ¸¬ä¸­...';
      document.getElementById('historyList').innerHTML = '';
      updateVisualAlert("quiet");

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
          mic = audioContext.createMediaStreamSource(stream);
          analyser = audioContext.createAnalyser();
          analyser.fftSize = 512;
          dataArray = new Uint8Array(analyser.frequencyBinCount);
          mic.connect(analyser);
          monitoring = true;
          loop();
        })
        .catch(err => {
          alert('ç„¡æ³•å–å¾—éº¥å…‹é¢¨ï¼š' + err.message);
        });
    }

    function loop() {
      if (!monitoring || isSpeaking) {
        rafId = requestAnimationFrame(loop);
        return;
      }

      analyser.getByteTimeDomainData(dataArray);
      let sum = 0;
      for (let i = 0; i < dataArray.length; i++) {
        let val = (dataArray[i] - 128) / 128;
        sum += val * val;
      }
      let rms = Math.sqrt(sum / dataArray.length);
      let db = 20 * Math.log10(rms);
      db = Math.max(0, Math.round(db + 90));

      document.getElementById('dbDisplay').textContent = `ç›®å‰éŸ³é‡ï¼š${db} dB`;

      if (db > threshold) {
        isSpeaking = true;

        exceedCount++;
        document.getElementById('exceedDisplay').textContent = `å·²è¶…éæ¬¡æ•¸ï¼š${exceedCount}`;
        updateVisualAlert("loud");
        addHistoryRecord(db);

        if (exceedCount >= maxExceed) {
          speak(document.getElementById("endText").value, () => {
            stopMonitoring();
          });
        } else {
          speak(document.getElementById("warningText").value, () => {
            isSpeaking = false;
            updateVisualAlert("quiet");
          });
        }
      } else {
        updateVisualAlert("quiet");
      }

      rafId = requestAnimationFrame(loop);
    }

    function stopMonitoring() {
      monitoring = false;
      if (rafId) cancelAnimationFrame(rafId);
      if (audioContext && audioContext.state !== 'closed') {
        audioContext.close();
      }
      document.getElementById('status').textContent = 'ç‹€æ…‹ï¼šå·²åœæ­¢';
      updateVisualAlert("quiet");
    }

    function updateVisualAlert(state) {
      const alertDiv = document.getElementById("visualAlert");
      if (state === "loud") {
        alertDiv.className = "loud";
        alertDiv.textContent = "å¤ªåµäº†ï¼";
      } else {
        alertDiv.className = "quiet";
        alertDiv.textContent = "ç›®å‰å®‰éœ";
      }
    }

    function addHistoryRecord(db) {
      const now = new Date();
      const time = now.toLocaleTimeString();
      const li = document.createElement("li");
      li.textContent = `ã€${time}ã€‘è¶…æ¨™éŸ³é‡ï¼š${db} dB`;
      document.getElementById("historyList").appendChild(li);
    }
  </script>
</body>
</html>
